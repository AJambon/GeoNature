<div class="container">

  <div style="margin-bottom: 10px;">
    <a
      mat-raised-button
      routerLink="/metadata"
    >
      <mat-icon> chevron_left</mat-icon> Retour
    </a>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3 class="main-color"> Jeu de données </h3>
        </div>
        <div class="card-body">

          <div>
            <small>Cadre d'acquisition </small>
            <select
              class="form-control form-control-sm"
              [formControl]="form.get('id_acquisition_framework')"
            >
              <option
                *ngFor="let af of (acquisitionFrameworks | async)"
                [disabled]="!af.opened"
                [title]="!af.opened ? 'Cadre cloturé' : af.acquisition_framework_name"
                [ngValue]="af.id_acquisition_framework"
              >
                {{af.acquisition_framework_name}}
              </option>
            </select>
          </div>

          <div>
            <small>Nom du JDD </small>
            <input
              class="form-control form-control-sm"
              type="text"
              [formControl]="form.get('dataset_name')"
            >
            <small
              *ngIf="form.get('dataset_name').errors?.maxlength"
              class="error"
              style="color:red"
            >
              Le nom du JDD doit être inférieur ou égal à 150 caractères
            </small>
          </div>

          <div class="row">
            <div class="col-md-8">
              <small>Nom court du JDD </small>
              <input
                class="form-control form-control-sm"
                type="text"
                [formControl]="form.get('dataset_shortname')"
              >
              <small
                *ngIf="form.get('dataset_shortname').errors?.maxlength"
                class="error"
                style="color:red"
              >
                Le nom court du JDD doit être inférieur ou égal à 30 caractères
              </small>
            </div>
          </div>

          <div>
            <small>Description</small>
            <textarea
              class="form-control form-control-sm"
              type="text"
              [formControl]="form.get('dataset_desc')"
            >
            </textarea>
          </div>

          <div>
            <small>Mots clés </small>
            <input
              class="form-control form-control-sm"
              type="text"
              [formControl]="form.get('keywords')"
            >
          </div>

          <div>
            <small>Domaine</small>
            <div>
              <div class="checkbox">
                <input
                  [formControl]="form.get('terrestrial_domain')"
                  type="checkbox"
                  id="terrestrial_domain"
                >
                <label for="terrestrial_domain">
                  Domaine terrestre
                </label>
              </div>
              <div class="checkbox">
                <input
                  [formControl]="form.get('marine_domain')"
                  type="checkbox"
                  id="marine_domain"
                >
                <label for="marine_domain">
                  Domaine marin
                </label>
              </div>
            </div>

          </div>

          <div class="row">
            <div class="col-md-6">
              <pnx-nomenclature
                label="Type de données"
                [parentFormControl]="form.get('id_nomenclature_data_type')"
                codeNomenclatureType="DATA_TYP"
              >
              </pnx-nomenclature>
            </div>

            <div class="col-md-6">
              <pnx-nomenclature
                label="Statut source"
                [parentFormControl]="form.get('id_nomenclature_source_status')"
                codeNomenclatureType="STATUT_SOURCE"
              >
              </pnx-nomenclature>
            </div>
          </div>

          <div>
            <pnx-nomenclature
              label="Objectif"
              [parentFormControl]="form.get('id_nomenclature_dataset_objectif')"
              codeNomenclatureType="JDD_OBJECTIFS"
            >
            </pnx-nomenclature>
          </div>

          <div>
            <pnx-nomenclature
              [multiSelect]="true"
              label="Territoires"
              [parentFormControl]="form.get('cor_territories')"
              codeNomenclatureType="TERRITOIRE"
              [bindAllItem]="true"
            >
            </pnx-nomenclature>
          </div>

          <div>
            <pnx-nomenclature
              label="Méthode de collecte"
              [parentFormControl]="form.get('id_nomenclature_collecting_method')"
              codeNomenclatureType="METHO_RECUEIL"
            >
            </pnx-nomenclature>
          </div>

          <div class="row">
            <div class="col-md-6">
              <pnx-nomenclature
                label="Origine des données"
                [parentFormControl]="form.get('id_nomenclature_data_origin')"
                codeNomenclatureType="DS_PUBLIQUE"
              >
              </pnx-nomenclature>
            </div>

            <div class="col-md-6">
              <pnx-nomenclature
                label="Type de ressource"
                [parentFormControl]="form.get('id_nomenclature_resource_type')"
                codeNomenclatureType="RESOURCE_TYP"
              >
              </pnx-nomenclature>
            </div>
          </div>

          <h5 style="margin-top: 10px;"> Spécifique GeoNature </h5>

          <div>
            <div class="checkbox">
              <input
                [formControl]="form.get('active')"
                type="checkbox"
                id="active"
              >
              <label for="active">
                Actif à la saisie
              </label>
            </div>
            <div class="checkbox">
              <input
                [formControl]="form.get('validable')"
                type="checkbox"
                id="validable"
              >
              <label for="validable">
                Validable
              </label>
            </div>
          </div>
          <small>Liste de taxon (facultatif)</small>
          <select
            class="form-control form-control-sm"
            [formControl]="form.get('id_taxa_list')"
          >
            <option [ngValue]="null"> --Selectionner une liste de taxon--</option>
            <option [ngValue]="-1"> Aucune liste (tout Taxref)</option>
            <option
              *ngFor="let list of taxaBibList"
              [ngValue]="list.id_liste"
            >
            {{list.nom_liste}}
          </option>
          </select>

          <div>
            <pnx-multiselect
              [values]="moduleService.modules"
              [parentFormControl]="form.get('modules')"
              keyLabel="module_label"
              keyValue="id_module"
              label="Module(s) GeoNature associé(s) au jeu de données"
              [bindAllItem]="true"
            >
            </pnx-multiselect>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h3 class="main-color"> Contact principal </h3>
        </div>
        <div class="card-body">
          <ng-container *ngFor="let actorForm of datasetFormS.actors.controls; let idx = index">
            <pnx-metadata-actor
              *ngIf="datasetFormS.isMainContact(actorForm)"
              [actorForm]="actorForm"
              metadataType="dataset"
              (actorFormRemove)="datasetFormS.removeActor(idx)"
            >
            </pnx-metadata-actor>
          </ng-container>
          <ng-container *ngIf="form.get('cor_dataset_actor').invalid && form.get('cor_dataset_actor').errors?.mainContactRequired; else addButton">
            <small
              class="mat-error">
              Le renseignement d'un contact principal est obligatoire
            </small>
            <div>
              <button
                type="button"
                mat-raised-button
                color="warn"
                (click)="addMainContact()"
              >
                Corriger
              </button>
            </div>
          </ng-container>
          <ng-template #addButton>
            <div>
              <button
                type="button"
                mat-mini-fab
                color="primary"
                (click)="addMainContact()"
              >
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </ng-template>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="main-color"> Autre(s) acteur(s) </h3>
        </div>
        <div class="card-body">
          <pnx-metadata-actor
            [actorForm]="genericActorForm"
            (actorFormSubmit)="genericActorFormSubmit($event)"
            metadataType="dataset"
          >
          </pnx-metadata-actor>

          <ng-container *ngIf="(datasetFormS.otherActorGroupForms|async) != {}">
            <ng-container *ngFor="let otherActorGroupForm of (datasetFormS.otherActorGroupForms|async) | keyvalue">
              <h5 class="actor-title"> {{ otherActorGroupForm.key }} </h5>
              <ng-container *ngFor="let otherActorForm of otherActorGroupForm.value; let idx = index">
                <!-- otherActorForm peut être undefined car setOtherActorGroupForms() conserve les indexs initiaux de form.cor_dataset_actor -->
                <pnx-metadata-actor
                  *ngIf="otherActorForm"
                  [actorForm]="otherActorForm"
                  (actorFormRemove)="datasetFormS.removeActor(idx)"
                  metadataType="dataset"
                >
                </pnx-metadata-actor>

              </ng-container>
            </ng-container>
          </ng-container>

        </div>
      </div>
    </div>
  </div>

  <div class="mr-1 mt-1">
    <button
      mat-raised-button
      type="button"
      color="warn"
      routerLink="/metadata"
    >
      Annuler
    </button>
    <button
      [disabled]="form.invalid"
      class="button-success ml-1"
      mat-raised-button
      (click)="postDataset()"
    >
      Enregistrer le jeu de données
    </button>

  </div>


</div>