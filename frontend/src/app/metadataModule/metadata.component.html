<div class="container-fluid">
  <div class="card card-page">
    <div class="card-header">
      <h3 class="underlined main-color"> Catalogue des jeux de données </h3>
    </div>

    <div class="card-body">
      <div class="row ml-4 mb-4">
        <button
          *ngIf="_cruvedStore.cruved?.METADATA?.cruved.C !== '0'"
          routerLink="/metadata/af"
          class="uppercase mr-1"
          mat-raised-button
          color="primary"
        >
          Ajouter un cadre d'acquisition
          &nbsp;
        </button>
        <button
          *ngIf="_cruvedStore.cruved?.METADATA?.cruved.C !== '0'"
          routerLink="/metadata/dataset"
          class="uppercase"
          mat-raised-button
          color="primary"
        >
          Ajouter un jeu de données
        </button>
      </div>
      <div class="row">
        <div class="form-group col-sm-7">
          <input
            class="form-control form-control-sm"
            type="text"
            name=""
            id=""
            placeholder="Rechercher"
            (keyup)="updateSearchbar($event)"
          >
        </div>
        <div class="col-sm-3">
          <button
            mat-raised-button
            color="primary"
            (click)="openSearchModal(searchModal)"
          > Recherche avancée </button>
          <button
            mat-raised-button
            color="accent"
            class="ml-2"
            matTooltip="Raffraichir la recherche"
            (click)="refreshFilters(searchModal)"
          > <mat-icon style="vertical-align: middle;">refresh</mat-icon> </button>
        </div>
      </div>
      <div>Liste des cadres d'acquisition et des jeux de données associés</div>
      <br>

      <mat-accordion [multi]="true">
        <div class="tab-title">
          <div class="col-md-1">ID </div>
          <div class="col-md-3"> Nom</div>
          <div class="col-md-2"> Date de création</div>
          <div class="col-md-2"> Créateur</div>
          <div class="col-md-3"> Acteurs</div>
          <div class="col-md-1"> Actions</div>
        </div>
        <ng-container *ngFor="let af of tempAF; let idx = index">
          <mat-expansion-panel
            *ngIf="isDisplayed(idx)"
            [expanded]="expandAccordions"
          >
            <mat-expansion-panel-header
              collapsedHeight="*"
              expandedHeight="*"
            >
              <mat-panel-title
                class="af-title"
                style="margin-top:2.5%;margin-bottom: 1.2%;"
              >

                <div class="col-md-1">{{ af.id_acquisition_framework }}</div>
                <div class="col-md-3"> <a
                    [routerLink]="['/metadata/af_detail', af.id_acquisition_framework]"
                  > {{ af.acquisition_framework_name | uppercase }} </a>
                  <br> <small class="muted"> {{ af.unique_acquisition_framework_id  }} </small>
                </div>
                <div class="col-md-2 ">{{af.acquisition_framework_start_date |date:'d/MM/yyyy'}}
                </div>
                <div class="col-md-2">
                  {{af.creator?.nom_complet}}
                </div>
                <section class="col-md-3">
                  <div *ngFor="let ac of af.cor_af_actor">
                    <span *ngIf="ac.organism">
                      <b> {{ac.organism?.nom_organisme }} : </b> 
                      <small> {{ac.nomenclature_actor_role.label_fr }}</small> <br>
                    </span>
                    <span *ngIf="ac.role">
                      <b>  {{ac.role?.nom_complet }} : </b> 
                        <small> {{ac.nomenclature_actor_role.label_fr }}</small> <br>
                    </span>

                  </div>
                </section>

                <div class="col-md-1"><a
                    style="color: black;"
                    [routerLink]="['/metadata/af', af.id_acquisition_framework]"
                  >
                    <mat-icon> create</mat-icon>
                  </a></div>

              </mat-panel-title>

            </mat-expansion-panel-header>
            <table class="table table-bordered">
              <thead class="bold">
                <tr>
                  <td style="width:1%">
                    Id
                  </td>
                  <td>Nom du JDD</td>
                  <td>Date de création</td>
                  <td>Nombre de données</td>
                  <td>Créateur</td>
                  <td>Rapport</td>
                  <td>Actions</td>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let ds of af.datasetsTemp; let last = last;">
                  <td>
                    <a [routerLink]="['/metadata/dataset_detail', ds.id_dataset]"> {{ds.id_dataset}}
                    </a>
                  </td>
                  <td>
                    <a [routerLink]="['/metadata/dataset_detail', ds.id_dataset]">
                      {{ds.dataset_name}}
                      <br />
                      <span style="color: gray"> {{ds.unique_dataset_id}} </span>
                    </a>
                  </td>
                  <td> {{ds.meta_create_date |date:'d/MM/yyyy' }}</td>
                  <td> {{ds.observation_count}} </td>
                  <td>{{ds.creator?.nom_complet}}<td>
                    <div *ngIf="ds.observation_count > 0">
                      <mat-icon
                        (click)="sensiReport(ds.id_dataset)"
                        matTooltip="Rapport de sensibilité"
                      > do_not_touch </mat-icon>
                      <mat-icon
                        class="ml-2"
                        (click)="uuidReport(ds.id_dataset)"
                        matTooltip="Rapport d'UUID"
                      > format_list_numbered </mat-icon>
                    </div>
                    <div *ngIf="ds.observation_count == 0">
                      <mat-icon matTooltip="Impossible de télécharger le rapport de sensibilité">
                        do_not_touch </mat-icon>
                      <mat-icon matTooltip="Impossible de télécharger le rapport d'UUID">
                        format_list_numbered </mat-icon>
                    </div>
                  </td>
                  <td *ngIf="ds.active"><a
                      style="color: black;"
                      [routerLink]="['/metadata/dataset', ds.id_dataset]"
                      matTooltip="Éditer un jeux de donnée"
                    >
                      <mat-icon> create</mat-icon>
                    </a>
                    <a
                      (click)="activateDs(ds.id_dataset, false)"
                      matTooltip="Jeux de donnée activé"
                    >
                      <mat-icon> done</mat-icon>
                    </a>
                    <a
                      (click)="importDs(ds.id_dataset)"
                      matTooltip="Importer dans ce jeu de donnée"
                    >
                      <mat-icon>backup</mat-icon>
                    </a>
                    <a
                      (click)="syntheseDs(ds.id_dataset, ds.observation_count, syntheseNoneModal)"
                      matTooltip="Afficher les données dans la Synthèse"
                    >
                      <mat-icon> room</mat-icon>
                    </a>
                    <a
                      *ngIf="ds.deletable"
                      (click)="deleteDs(ds.id_dataset)"
                      matTooltip="Supprimer un jeux de donnée"
                    >
                      <mat-icon> delete</mat-icon>
                    </a>
                    <a
                      *ngIf="!ds.deletable"
                      matTooltip="La suppression du jeu de données n'est pas possible car des données y sont rattachées dans la Synthèse"
                    >
                      <mat-icon disabled>delete_outline</mat-icon>
                    </a>
                  </td>
                  <td *ngIf="!ds.active"><a
                      style="color: black;"
                      [routerLink]="['/metadata/dataset', ds.id_dataset]"
                      matTooltip="Éditer un jeu de donnée"
                    >
                      <mat-icon> create</mat-icon>
                    </a>
                    <a
                      (click)="activateDs(ds.id_dataset, true)"
                      matTooltip="Jeux de donnée désactivé"
                    >
                      <mat-icon> clear</mat-icon>
                    </a>
                    <a
                      *ngIf="ds.deletable"
                      (click)="deleteDs(ds.id_dataset)"
                      matTooltip="Supprimer le jeu de données"
                    >
                      <mat-icon> delete</mat-icon>
                    </a>
                    <a
                      *ngIf="!ds.deletable"
                      matTooltip="La suppression du jeu de données n'est pas possible car des données y sont rattachées dans la Synthèse"
                    >
                      <mat-icon>delete_outline</mat-icon>
                    </a>
                  </td>
                </tr>
              </tbody>
            </table>
          </mat-expansion-panel>
        </ng-container>

      </mat-accordion>
      <mat-paginator
        #paginator
        [length]="tempAF.length"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        (page)="changePaginator($event)"
      >
      </mat-paginator>


    </div>
  </div>
</div>


<ng-template
  #searchModal
  let-c="close"
  let-d="dismiss"
>
  <div class="modal-header">
    <h5
      class="modal-title"
      id="exampleModalLabel"
    > Rechercher </h5>
  </div>
  <div
    class="modal-body"
    style="align-items: flex-end;"
  >
      <label>  Rechercher sur:</label>
        <select
        [formControl]="searchFormService.form.get('selector')"
          name="selecteur"
          id="selector"
          class="form-control"
        >
          <option value="ds">Jeu de données</option>
          <option value="af">Cadre d'acquisition</option>
        </select>
      <label>UUID</label>
        <input
        [formControl]="searchFormService.form.get('uuid')"
          class="form-control form-control-sm"
          type="text"
        >
        <label>Titre / Identifiant</label>
        
        <input
          [formControl]="searchFormService.form.get('name')"
          class="form-control form-control-sm"
        >

      <pnx-date [parentFormControl]="searchFormService.form.get('date')" label="Date de création"></pnx-date>
        <label>Acteur (organisme)</label>
        
        <select
          [formControl]="searchFormService.form.get('organism')"

          class="form-control form-control"
        >
          <option
            value=""
            selected
          >--</option>
          <option
            *ngFor="let org of organisms"
            value="{{org.id_organisme}}"
          >
            {{org.nom_organisme}} </option>
        </select>
        <label> Acteur (personne)</label>
        
        <select
          class="form-control form-control"
          [formControl]="searchFormService.form.get('person')"
        >
          <option
            value=""
            selected
          > --</option>
          <option
            *ngFor="let role of roles"
            value="{{role.id_role}}"
          >
            {{role?.nom_complet}}</option>
        </select>

        <div class="mt-2">
          <button
          mat-raised-button
          class="button-success uppercase mr-2"
          (click)="advancedSearch(); c()"
        > Rechercher </button>
        <button
          mat-raised-button
          color="warn"
          class="uppercase"
          (click)="c()"
        > 
          Fermer 
        </button>
        </div>

  </div>
</ng-template>




<ng-template
  #syntheseNoneModal
  let-c="close"
  let-d="dismiss"
>
  <div class="modal-header bg-danger">
    <h5
      class="modal-title text-white"
      id="exampleModalLabel"
    >La visualisation des données n'est pas possible !</h5>
  </div>
  <div
    class="modal-body"
    style="align-items: flex-end;"
  >
    <div class="col">
      <span>
        <h4 style="text-align: justify;">Le nombre de données est égale à zéro</h4>
      </span>
    </div>
  </div>

  <div class="row">
    <div class="col">
    </div>
    <div class="col-md-4 text-center">
      <button
        mat-raised-button
        color="primary"
        (click)="c()"
      > Fermer </button>
    </div>
    <br>
  </div>

</ng-template>
