<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>INSTALLATION &mdash; GeoNature 2.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="MANUEL UTILISATEUR" href="user-manual.html" />
    <link rel="prev" title="Bienvenue dans la documentation de GeoNature" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="index.html" class="icon icon-home"> GeoNature
            <img src="_static/LogoGeonature.jpg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">INSTALLATION</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequis">Prérequis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preparation-du-serveur">Préparation du serveur</a></li>
<li class="toctree-l2"><a class="reference internal" href="#installation-globale">Installation globale</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installation-de-l-application">Installation de l’application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#installation-d-un-module-geonature">Installation d’un module GeoNature</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installation-de-geonature-uniquement">Installation de GeoNature uniquement</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installation-des-dependances">Installation des dépendances</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id1">Installation de l’application</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id4">Installation de l’application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-apache">Configuration Apache</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dependances">Dépendances</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mise-a-jour-de-l-application">Mise à jour de l’application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#passer-en-mode-developpement">Passer en mode développement</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#specificites-depobio">Spécificités DEPOBIO</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id5">Configuration Apache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-de-l-application">Configuration de l’application</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configuration-globale-de-l-application">Configuration globale de l’application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-des-urls-pour-le-cas">Configuration des URLS pour le CAS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cle-secrete">Clé secrète</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-bdd-liee-a-la-connexion-au-cas">Configuration BDD liée à la connexion au CAS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#connexion-au-cas-inpn-gestion-centralisee-des-utilisateurs">Connexion au CAS INPN - gestion centralisée des utilisateurs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-du-frontend">Configuration du frontend</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-de-la-cartographie">Configuration de la cartographie</a></li>
<li class="toctree-l4"><a class="reference internal" href="#configuration-du-module-occurrence-de-taxon-occtax">Configuration du module Occurrence de taxon: OCCTAX</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#referentiel-geographique">Référentiel géographique</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authentification-cas-inpn">Authentification CAS INPN</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connexion-et-droits-dans-geonature">Connexion et droits dans GeoNature</a></li>
<li class="toctree-l3"><a class="reference internal" href="#recuperation-des-jdd">Récupération des JDD</a></li>
<li class="toctree-l3"><a class="reference internal" href="#module-synthese">Module Synthese</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="user-manual.html">MANUEL UTILISATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="admin-manual.html">MANUEL ADMINISTRATEUR</a></li>
<li class="toctree-l1"><a class="reference internal" href="import-level-1.html">IMPORT NIVEAU 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="import-level-2.html">IMPORT NIVEAU 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">DEVELOPPEMENT</a></li>
<li class="toctree-l1"><a class="reference internal" href="versions-compatibility.html">COMPATIBILITE</a></li>
<li class="toctree-l1"><a class="reference internal" href="conf-apache.html">CONFIGURATION APACHE</a></li>
<li class="toctree-l1"><a class="reference internal" href="https.html">HTTPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="authors.html">AUTEURS</a></li>
<li class="toctree-l1"><a class="reference internal" href="CHANGELOG.html">CHANGELOG</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">GeoNature</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>INSTALLATION</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/installation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="installation">
<h1>INSTALLATION<a class="headerlink" href="#installation" title="Permalink to this headline"></a></h1>
<p>GeoNature repose sur les composants suivants :</p>
<ul class="simple">
<li><p>PostgreSQL / PostGIS</p></li>
<li><p>Python 3 et dépendances Python nécessaires à l’application</p></li>
<li><p>Flask (framework web Python)</p></li>
<li><p>Apache</p></li>
<li><p>Angular 7, Angular CLI, NodeJS</p></li>
<li><p>Librairies javascript (Leaflet, ChartJS)</p></li>
<li><p>Librairies CSS (Bootstrap, Material Design)</p></li>
</ul>
<p>Deux méthodes d’installation existent :</p>
<ul class="simple">
<li><p><a class="reference internal" href="#installation-all"><span class="std std-ref">Installation globale</span></a> : Installation de GeoNature, TaxHub et UsersHub.</p></li>
<li><p><a class="reference internal" href="#installation-standalone"><span class="std std-ref">Installation de GeoNature uniquement</span></a> : TaxHub et UsersHub ne sont pas installé (mais leur schémas sont tous de même créés dans la base de données).</p></li>
</ul>
<div class="section" id="prerequis">
<h2>Prérequis<a class="headerlink" href="#prerequis" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Ressources minimum serveur :</p>
<ul>
<li><p>Un serveur Debian 10 ou Debian 11 architecture 64-bits</p></li>
<li><p>4 Go RAM</p></li>
<li><p>20 Go d’espace disque</p></li>
</ul>
</li>
<li><p>GeoNature nécessite d’accéder à des ressources externes durant son installation et son fonctionnement. Si vous utilisez un serveur mandataire, celui-ci doit permettre l’accès aux domaines suivants :</p>
<ul>
<li><p><a class="reference external" href="https://pypi.python.org">https://pypi.python.org</a></p></li>
<li><p><a class="reference external" href="https://geonature.fr/">https://geonature.fr/</a></p></li>
<li><p><a class="reference external" href="https://codeload.github.com/">https://codeload.github.com/</a></p></li>
<li><p><a class="reference external" href="https://nodejs.org/dist">https://nodejs.org/dist</a></p></li>
<li><p><a class="reference external" href="https://registry.npmjs.org">https://registry.npmjs.org</a></p></li>
<li><p><a class="reference external" href="https://www.npmjs.com">https://www.npmjs.com</a></p></li>
<li><p><a class="reference external" href="https://raw.githubusercontent.com/">https://raw.githubusercontent.com/</a></p></li>
<li><p><a class="reference external" href="https://inpn.mnhn.fr/mtd">https://inpn.mnhn.fr/mtd</a></p></li>
<li><p><a class="reference external" href="https://preprod-inpn.mnhn.fr/mtd">https://preprod-inpn.mnhn.fr/mtd</a></p></li>
<li><p><a class="reference external" href="https://wxs.ign.fr/">https://wxs.ign.fr/</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="preparation-du-serveur">
<span id="preparation-server"></span><h2>Préparation du serveur<a class="headerlink" href="#preparation-du-serveur" title="Permalink to this headline"></a></h2>
<p>Commencer la procédure en se connectant au serveur en SSH avec l’utilisateur linux <code class="docutils literal notranslate"><span class="pre">root</span></code>.</p>
<ul>
<li><p>Mettre à jour de la liste des dépôts Linux :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt update</span>
<span class="c1"># apt upgrade</span>
</pre></div>
</div>
</li>
<li><p>Configuration de la locale du serveur</p>
<p>Certains serveurs sont livrés sans “locale” (langue par défaut). Pour l’installation de GeoNature, il est nécessaire de bien configurer la locale. Si la commande <code class="docutils literal notranslate"><span class="pre">locale</span></code> renvoie ceci :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LANG</span><span class="o">=</span><span class="n">fr_FR</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">LANGUAGE</span><span class="o">=</span><span class="n">fr_FR</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
<span class="n">LC_CTYPE</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_NUMERIC</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_TIME</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_COLLATE</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_MONETARY</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_MESSAGES</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_PAPER</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_NAME</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_ADDRESS</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_TELEPHONE</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_MEASUREMENT</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_IDENTIFICATION</span><span class="o">=</span><span class="s2">&quot;fr_FR.UTF-8&quot;</span>
<span class="n">LC_ALL</span><span class="o">=</span><span class="n">fr_FR</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
</pre></div>
</div>
<p>Vous pouvez alors passer cette étape de configuration des locales.</p>
<p>Sinon exécuter la commande <code class="docutils literal notranslate"><span class="pre">dpkg-reconfigure</span> <span class="pre">locales</span></code>. Une fenêtre s’affiche dans votre console. Dans la liste déroulante, sélectionnez <code class="docutils literal notranslate"><span class="pre">fr_FR.UTF-8</span> <span class="pre">UTF-8</span></code> avec <code class="docutils literal notranslate"><span class="pre">Espace</span></code>, puis cliquez sur OK. Une 2ème fenêtre s’affiche avec une liste de locale activées (<code class="docutils literal notranslate"><span class="pre">fr_FR.UTF-8</span></code> doit être présent dans la liste), confirmez votre choix, en cliquant sur OK, puis attendez que la locale s’installe.</p>
</li>
<li><p>Installer l’utilitaire <code class="docutils literal notranslate"><span class="pre">sudo</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># apt install sudo</span>
</pre></div>
</div>
</li>
<li><p>Créer un utilisateur Linux dédié (nommé <code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code> dans notre cas) pour ne pas travailler en <code class="docutils literal notranslate"><span class="pre">root</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># adduser geonatureadmin</span>
</pre></div>
</div>
</li>
<li><p>Lui donner ensuite les droits administrateur en l’ajoutant au groupe <code class="docutils literal notranslate"><span class="pre">sudo</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># adduser geonatureadmin sudo</span>
</pre></div>
</div>
</li>
<li><p>Pour la suite du processus d’installation, on utilisera ’utilisateur non privilégié nouvellement créé. Si besoin d’éxecuter des commandes avec les droits d’administrateur, on les précèdera de <code class="docutils literal notranslate"><span class="pre">sudo</span></code>. Il est d’ailleurs possible renforcer la sécurité du serveur en bloquant la connexion SSH au serveur avec <code class="docutils literal notranslate"><span class="pre">root</span></code>. Voir <a class="reference external" href="https://docs.ovh.com/fr/vps/conseils-securisation-vps/">https://docs.ovh.com/fr/vps/conseils-securisation-vps/</a> pour plus d’informations sur le sécurisation du serveur. Pour passer de l’utilisateur <code class="docutils literal notranslate"><span class="pre">root</span></code> à <code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code>, vous pouvez aussi utiliser la commande :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># su - geonatureadmin</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="installation-globale">
<span id="installation-all"></span><h2>Installation globale<a class="headerlink" href="#installation-globale" title="Permalink to this headline"></a></h2>
<p>Ce document décrit une procédure d’installation packagée de GeoNature.</p>
<p>En lançant le script d’installation ci-dessous, l’application GeoNature ainsi que ses dépendances seront installées sur un seul et même serveur au sein d’une seule base de données.</p>
<p>Les applications suivantes seront installées :</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/PnX-SI/GeoNature">GeoNature</a></p></li>
<li><p><a class="reference external" href="https://github.com/PnX-SI/TaxHub">TaxHub</a> qui pilote le schéma <code class="docutils literal notranslate"><span class="pre">taxonomie</span></code></p></li>
<li><p><a class="reference external" href="https://github.com/PnX-SI/UsersHub">UsersHub</a> qui pilote le schéma <code class="docutils literal notranslate"><span class="pre">utilisateurs</span></code> (le paramètre <code class="docutils literal notranslate"><span class="pre">install_usershub_app</span></code> du fichier de configuration <code class="docutils literal notranslate"><span class="pre">install_all.ini</span></code> permet de désactiver l’installation de l’application. Il est cependant recommandé d’installer l’application pour disposer d’une interface pour gérer les utilisateurs dans GeoNature)</p></li>
</ul>
<p>Si vous disposez déjà de Taxhub ou de UsersHub sur un autre serveur ou une autre base de données et que vous souhaitez installer simplement GeoNature, veuillez suivre la documentation <a class="reference internal" href="#installation-standalone"><span class="std std-ref">Installation de GeoNature uniquement</span></a>.</p>
<div class="section" id="installation-de-l-application">
<h3>Installation de l’application<a class="headerlink" href="#installation-de-l-application" title="Permalink to this headline"></a></h3>
<p>Commencer la procédure en se connectant au serveur en SSH avec l’utilisateur dédié précédemment créé lors de l’étape de <a class="reference internal" href="#preparation-server"><span class="std std-ref">Préparation du serveur</span></a> (usuellement <code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code>).</p>
<ul class="simple">
<li><p>Se placer à la racine du <code class="docutils literal notranslate"><span class="pre">home</span></code> de l’utilisateur puis récupérer les scripts d’installation (X.Y.Z à remplacer par le numéro de la <a class="reference external" href="https://github.com/PnEcrins/GeoNature/releases">dernière version stable de GeoNature</a>). Ces scripts installent les applications GeoNature, TaxHub et UsersHub (en option) ainsi que leurs bases de données (uniquement les schémas du coeur) :</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget https://raw.githubusercontent.com/PnX-SI/GeoNature/X.Y.Z/install/install_all/install_all.ini
$ wget https://raw.githubusercontent.com/PnX-SI/GeoNature/X.Y.Z/install/install_all/install_all.sh
</pre></div>
</div>
<p><em>Attention</em> : l’installation globale fonctionne uniquement si les scripts sont placés à la racine du <code class="docutils literal notranslate"><span class="pre">home</span></code> de l’utilisateur courant.</p>
<ul class="simple">
<li><p>Configurez votre installation en adaptant le fichier <code class="docutils literal notranslate"><span class="pre">install_all.ini</span></code> :</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nano</span> <span class="n">install_all</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>Renseignez à minima votre utilisateur linux, l’URL (ou IP) de votre serveur (avec un <code class="docutils literal notranslate"><span class="pre">/</span></code> à la fin) ainsi que l’utilisateur PostgreSQL que vous souhaitez et son mot de passe. Le script se chargera d’installer PostgreSQL et de créer l’utilisateur de base de données que vous avez renseigné.</p>
<p>Pour la définition des numéros de version des dépendances, voir le <a class="reference external" href="versions-compatibility.rst">tableau de compatibilité</a> des versions de GeoNature avec ses dépendances. Il est déconseillé de modifier ces versions, chaque nouvelle version de GeoNature étant fournie avec les versions adaptées de ses dépendances.</p>
<ul class="simple">
<li><p>Lancer l’installation :</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">touch</span> <span class="n">install_all</span><span class="o">.</span><span class="n">log</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">install_all</span><span class="o">.</span><span class="n">sh</span>
<span class="o">./</span><span class="n">install_all</span><span class="o">.</span><span class="n">sh</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">install_all</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Une fois l’installation terminée, lancez la commande suivante:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exec</span> <span class="n">bash</span>
</pre></div>
</div>
<p>Les applications sont disponibles aux adresses suivantes :</p>
<ul class="simple">
<li><p><a class="reference external" href="http://monip.com/geonature/">http://monip.com/geonature/</a></p></li>
<li><p><a class="reference external" href="http://monip.com/taxhub/">http://monip.com/taxhub/</a></p></li>
<li><p><a class="reference external" href="http://monip.com/usershub/">http://monip.com/usershub/</a> (en option)</p></li>
</ul>
<p>Vous pouvez vous connecter avec l’utilisateur intégré par défaut (admin/admin).</p>
<dl class="field-list simple">
<dt class="field-odd">Note</dt>
<dd class="field-odd"><p>Pour en savoir plus TaxHub, sa configuration et son utilisation, reportez-vous à sa documentation : <a class="reference external" href="https://taxhub.readthedocs.io">https://taxhub.readthedocs.io</a>. Idem pour UsersHub et sa documentation : <a class="reference external" href="https://usershub.readthedocs.io">https://usershub.readthedocs.io</a></p>
</dd>
<dt class="field-even">Note</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>GeoNature-atlas</strong> : Comme dans la V1, le script <code class="docutils literal notranslate"><span class="pre">install_all.sh</span></code> permettra à terme d’installer automatiquement GeoNature-atlas (en option)</p></li>
<li><p>Une première version de GeoNature-atlas compatible avec GeoNature V2 est disponible : <a class="reference external" href="https://github.com/PnEcrins/GeoNature-atlas">https://github.com/PnEcrins/GeoNature-atlas</a></p></li>
<li><p>Vous pouvez utiliser le schéma <code class="docutils literal notranslate"><span class="pre">ref_geo</span></code> de GeoNature pour votre territoire, les communes et les mailles, si vous les avez intégré dans <code class="docutils literal notranslate"><span class="pre">ref_geo.l_areas</span></code> au préalable.</p></li>
</ul>
</dd>
<dt class="field-odd">Note</dt>
<dd class="field-odd"><p>Une version expérimentale du calcul automatique de la sensibilité est disponible : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/issues/284">https://github.com/PnX-SI/GeoNature/issues/284</a></p>
</dd>
</dl>
<p>Si vous rencontrez une erreur, se reporter aux fichiers de logs :</p>
<ul class="simple">
<li><p>Logs de l’installation de la base de données : <code class="docutils literal notranslate"><span class="pre">/home/`whoami`/geonature/var/log/install_db.log</span></code></p></li>
<li><p>Log général de l’installation de l’application : <code class="docutils literal notranslate"><span class="pre">/home/`whoami`/install_all.log</span></code></p></li>
</ul>
<p>Si vous souhaitez que GeoNature soit à la racine du serveur, ou à une autre adresse, editez le fichier de configuration Apache (<code class="docutils literal notranslate"><span class="pre">/etc/apache2/sites-available/geonature.conf</span></code>) en modifiant l’alias :</p>
<ul class="simple">
<li><p>Pour <code class="docutils literal notranslate"><span class="pre">/</span></code>: <code class="docutils literal notranslate"><span class="pre">Alias</span> <span class="pre">/</span> <span class="pre">/home/test/geonature/frontend/dist</span></code></p></li>
<li><p>Pour <code class="docutils literal notranslate"><span class="pre">/saisie</span></code> : <code class="docutils literal notranslate"><span class="pre">Alias</span> <span class="pre">/saisie</span> <span class="pre">/home/test/geonature/frontend/dist</span></code></p></li>
</ul>
<dl class="field-list simple">
<dt class="field-odd">Note</dt>
<dd class="field-odd"><p>Par défaut la base de données est accessible uniquement localement par la machine où elle est installée. Pour y accéder depuis une autre machine (pour s’y connecter avec QGIS, pgAdmin ou autre), ouvrez-en les connexions. Voir la documentation <a class="reference external" href="https://github.com/PnEcrins/GeoNature-atlas/blob/master/docs/installation.rst#acc%C3%A9der-%C3%A0-votre-bdd">https://github.com/PnEcrins/GeoNature-atlas/blob/master/docs/installation.rst#acc%C3%A9der-%C3%A0-votre-bdd</a>. Attention si vous redémarrez PostgreSQL (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">postgresql</span> <span class="pre">restart</span></code>), il faut ensuite redémarrer les API GeoNature et TaxHub (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">supervisorctl</span> <span class="pre">reload</span></code>).</p>
</dd>
<dt class="field-even">Note</dt>
<dd class="field-even"><p>Il est aussi important de configurer l’accès au serveur en HTTPS plutôt qu’en HTTP pour chiffrer le contenu des échanges entre le navigateur et le serveur (<a class="reference external" href="https://docs.ovh.com/fr/hosting/les-certificats-ssl-sur-les-hebergements-web/">https://docs.ovh.com/fr/hosting/les-certificats-ssl-sur-les-hebergements-web/</a>).</p>
</dd>
</dl>
</div>
<div class="section" id="installation-d-un-module-geonature">
<h3>Installation d’un module GeoNature<a class="headerlink" href="#installation-d-un-module-geonature" title="Permalink to this headline"></a></h3>
<p>L’installation de GeoNature n’est livrée qu’avec les schémas de base de données et les modules du coeur (NB : le module Occurrence de Taxon - Occtax - est fourni par défaut). Pour ajouter un gn_module externe, il est nécessaire de l’installer :</p>
<p><strong>1.</strong> Téléchargez le module depuis son dépôt Github puis dézippez-le dans le repertoire utilisateur, au même niveau que le dossier <code class="docutils literal notranslate"><span class="pre">geonature</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cd /home/`whoami`
</pre></div>
</div>
<p><strong>2.</strong> Renseignez l’éventuel fichier <code class="docutils literal notranslate"><span class="pre">config/settings.ini</span></code> du module.</p>
<p><strong>3.</strong> Installez le module. Rendez-vous dans le répertoire <code class="docutils literal notranslate"><span class="pre">backend</span></code> de GeoNature et activez le virtualenv pour rendre disponible les commandes GeoNature :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
</pre></div>
</div>
<p>Lancez ensuite la commande <code class="docutils literal notranslate"><span class="pre">geonature</span> <span class="pre">install_gn_module</span> <span class="pre">&lt;mon_chemin_absolu_vers_le_module&gt;</span> <span class="pre">&lt;url_relative_du_module&gt;</span></code></p>
<p>Le premier paramètre est l’emplacement absolu du module sur votre serveur et le deuxième est le chemin derrière lequel on accédera au module dans le navigateur.</p>
<p>Exemple pour un module Import :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>geonature install_gn_module /home/`whoami`/gn_module_import import
</pre></div>
</div>
<p>Le module sera disponible à l’adresse <code class="docutils literal notranslate"><span class="pre">http://mon-geonature.fr/geonature/#/import</span></code></p>
<p>L’API du module sera disponible à l’adresse <code class="docutils literal notranslate"><span class="pre">http://mon-geonature.fr/api/import</span></code></p>
<p>Cette commande exécute les actions suivantes :</p>
<ul class="simple">
<li><p>Vérification de la conformité de la structure du module (présence des fichiers et dossiers obligatoires)</p></li>
<li><p>Intégration du blueprint du module dans l’API de GeoNature</p></li>
<li><p>Vérification de la conformité des paramètres utilisateurs</p></li>
<li><p>Génération du routing Angular pour le frontend</p></li>
<li><p>Re-build du frontend pour une mise en production</p></li>
</ul>
<p><strong>4.</strong> Complétez l’éventuelle configuration du module (<code class="docutils literal notranslate"><span class="pre">config/conf_gn_module.toml</span></code>) à partir des paramètres présents dans <code class="docutils literal notranslate"><span class="pre">config/conf_gn_module.toml.example</span></code> dont vous pouvez surcoucher les valeurs par défaut. Puis relancez la mise à jour de la configuration (depuis le répertoire <code class="docutils literal notranslate"><span class="pre">geonature/backend</span></code> et une fois dans le venv (<code class="docutils literal notranslate"><span class="pre">source</span> <span class="pre">venv/bin/activate</span></code>) : <code class="docutils literal notranslate"><span class="pre">geonature</span> <span class="pre">update_module_configuration</span> <span class="pre">nom_du_module</span></code>)</p>
</div>
</div>
<div class="section" id="installation-de-geonature-uniquement">
<span id="installation-standalone"></span><h2>Installation de GeoNature uniquement<a class="headerlink" href="#installation-de-geonature-uniquement" title="Permalink to this headline"></a></h2>
<p>Cette procédure détail l’installation de GeoNature seul, sans TaxHub et UsersHub.
Si vous souhaitez installer GeoNature avec TaxHub et UsersHub, reportez-vous à la section <a class="reference internal" href="#installation-all"><span class="std std-ref">Installation globale</span></a>.</p>
<div class="section" id="installation-des-dependances">
<h3>Installation des dépendances<a class="headerlink" href="#installation-des-dependances" title="Permalink to this headline"></a></h3>
<p>Installer les paquets suivants :</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt install unzip git postgresql postgis python2 python3-pip python3-venv libgdal-dev libpangocairo-1.0-0 apache2
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id1">
<h3>Installation de l’application<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h3>
<ul>
<li><p>Se placer dans le répertoire de l’utilisateur (<code class="docutils literal notranslate"><span class="pre">/home/geonatureadmin/</span></code> dans notre cas)</p></li>
<li><p>Récupérer l’application (<code class="docutils literal notranslate"><span class="pre">X.Y.Z</span></code> à remplacer par le numéro de la <a class="reference external" href="https://github.com/PnEcrins/GeoNature/releases">dernière version stable de GeoNature</a>). Voir le <a class="reference external" href="versions-compatibility.rst">tableau de compatibilité</a> des versions de GeoNature avec ses dépendances.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ wget https://github.com/PnX-SI/GeoNature/archive/X.Y.Z.zip
</pre></div>
</div>
</li>
<li><p>Dézipper l’archive de l’application</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ unzip X.Y.Z.zip
$ rm X.Y.Z.zip
</pre></div>
</div>
</li>
<li><p>Renommer le répertoire de l’application puis placez-vous dedans :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mv GeoNature-X.Y.Z /home/`whoami`/geonature/
$ cd geonature
</pre></div>
</div>
</li>
<li><p>Copier puis mettre à jour le fichier de configuration (<code class="docutils literal notranslate"><span class="pre">config/settings.ini</span></code>) comportant les informations relatives à votre environnement serveur :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ cp config/settings.ini.sample config/settings.ini
$ nano config/settings.ini
</pre></div>
</div>
</li>
</ul>
<div class="section" id="id4">
<h4>Installation de l’application<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h4>
<p>Rendez vous dans le dossier <code class="docutils literal notranslate"><span class="pre">install</span></code> et lancez successivement dans l’ordre les scripts suivant :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">01_install_backend.sh</span></code> : Création du virtualenv python, installation des dépendances et du backend GeoNature dans celui-ci, création du service systemd (permettant d’utiliser <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">{start,stop}</span> <span class="pre">geonature2</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">02_create_db.sh</span></code> : Création du role postgresql, de la base de données, ajout des extensions nécessaires (postgis, …), création des schémas nécessaires à GeoNature et ajout des données métiers.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">03_install_gn_modules.sh</span></code> : Installation des modules OccTax, OccHab et validation (si activé dans le fichier <cite>settings.ini</cite>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">04_install_frontend.sh</span></code> : Création des dossiers et liens symboliques nécessaires, création des fichier custom à partir des fichiers d’exemple, génération des fichiers de configuration grâce à la commande <cite>geonature</cite>, installation de nvm, npm et node ainsi que toutes les dépendances javascript nécessaires puis build du front.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">05_configure_apache.sh</span></code> : Installation du fichier de configuration Apache <code class="docutils literal notranslate"><span class="pre">/etc/apache2/conf-available/geonature.conf</span></code> et activation des modules Apache nécessaires.</p></li>
</ul>
<p>Vous pouvez alors démarrer le backend GeoNature : <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">start</span> <span class="pre">geonature2</span></code></p>
</div>
<div class="section" id="configuration-apache">
<h4>Configuration Apache<a class="headerlink" href="#configuration-apache" title="Permalink to this headline"></a></h4>
<ul>
<li><p>Copiez et adaptez le fichier de configuration d’exemple d’Apache de GeoNature :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo cp install/assets/geonature_apache.conf /etc/apache2/sites-available/geonature.conf
$ sudo nano /etc/apache2/sites-available/geonature.conf
</pre></div>
</div>
</li>
<li><p>Activez les modules suivants :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo a2enmod rewrite
$ sudo a2enmod proxy
$ sudo a2enmod proxy_http
</pre></div>
</div>
</li>
<li><p>Activez la nouvelle configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo a2ensite geonature.conf
</pre></div>
</div>
</li>
<li><p>et redémarrez Apache:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo systemctl restart apache2
</pre></div>
</div>
</li>
<li><p>L’application est disponible à l’adresse suivante : <a class="reference external" href="http://monip.com/geonature">http://monip.com/geonature</a></p></li>
</ul>
</div>
</div>
<div class="section" id="dependances">
<h3>Dépendances<a class="headerlink" href="#dependances" title="Permalink to this headline"></a></h3>
<p>Lors de l’installation de la BDD (<code class="docutils literal notranslate"><span class="pre">02_create_db.sh</span></code>) le schéma <code class="docutils literal notranslate"><span class="pre">utilisateurs</span></code> de UsersHub et le schéma <code class="docutils literal notranslate"><span class="pre">taxonomie</span></code> de TaxHub sont intégrés automatiquement dans la BDD de GeoNature.</p>
<p>UsersHub n’est pas nécessaire au fonctionnement de GeoNature mais il sera utile pour avoir une interface de gestion des utilisateurs, des groupes et de leurs droits.</p>
<p>Par contre il est nécessaire d’installer TaxHub (<a class="reference external" href="https://github.com/PnX-SI/TaxHub">https://github.com/PnX-SI/TaxHub</a>) pour que GeoNature fonctionne. En effet, GeoNature utilise l’API de TaxHub. Une fois GeoNature installé, il vous faut donc installer TaxHub en le connectant à la BDD de GeoNature, vu que son schéma <code class="docutils literal notranslate"><span class="pre">taxonomie</span></code> a déjà été installé par le script <code class="docutils literal notranslate"><span class="pre">02_create_db.sh</span></code> de GeoNature. Lors de l’installation de TaxHub, n’installez donc que l’application et pas la BDD.</p>
<p>Télécharger Taxhub depuis le dépôt github depuis la racine de votre utilisateur:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">~</span>
<span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PnX</span><span class="o">-</span><span class="n">SI</span><span class="o">/</span><span class="n">TaxHub</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">unzip</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">rm</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
<p>en mode développeur:</p>
<p><code class="docutils literal notranslate"><span class="pre">https://github.com/PnX-SI/TaxHub.git</span></code></p>
<p>Rendez vous dans le répertoire téléchargé et dézippé, puis “désamplez” le fichier <code class="docutils literal notranslate"><span class="pre">settings.ini</span></code> et remplissez la configuration avec les paramètres de connexion à la BDD GeoNature précedemment installée :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="n">settings</span><span class="o">.</span><span class="n">ini</span><span class="o">.</span><span class="n">sample</span> <span class="n">settings</span><span class="o">.</span><span class="n">ini</span>
<span class="n">nano</span> <span class="n">settings</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
<p>Lancer le script d’installation de l’application :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">var</span>
<span class="n">mkdir</span> <span class="n">var</span><span class="o">/</span><span class="n">log</span>
<span class="n">touch</span> <span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">install_app</span><span class="o">.</span><span class="n">log</span>
<span class="o">./</span><span class="n">install_app</span><span class="o">.</span><span class="n">sh</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">install_app</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Suite à l’execution de ce script, l’application Taxhub a été lancé automatiquement par le superviseur et est disponible à l’adresse <code class="docutils literal notranslate"><span class="pre">127.0.0.1:5000</span></code> (et l’API, à <code class="docutils literal notranslate"><span class="pre">127.0.0.1:5000/api</span></code>)</p>
<p>Voir la doc d’installation de TaxHub : <a class="reference external" href="http://taxhub.readthedocs.io/">http://taxhub.readthedocs.io/</a></p>
<p>Voir la doc d’installation de UsersHub : <a class="reference external" href="http://usershub.readthedocs.io/">http://usershub.readthedocs.io/</a></p>
</div>
<div class="section" id="mise-a-jour-de-l-application">
<h3>Mise à jour de l’application<a class="headerlink" href="#mise-a-jour-de-l-application" title="Permalink to this headline"></a></h3>
<p>Attention, avant chaque mise à jour, il est important de sauvegarder l’application et sa base de données, ou de faire un snapshot du serveur pour pouvoir revenir à son état antérieure avant mise à jour en cas de problème.</p>
<p>La mise à jour de GeoNature consiste à télécharger sa nouvelle version dans un nouveau répertoire, récupérer les fichiers de configuration et de surcouche depuis la version actuelle et de relancer l’installation dans le répertoire de la nouvelle version.</p>
<p>La mise à jour doit être réalisée avec votre utilisateur linux courant (<code class="docutils literal notranslate"><span class="pre">geonatureadmin</span></code> par exemple) et non pas le super-utilisateur <code class="docutils literal notranslate"><span class="pre">root</span></code>.</p>
<ul>
<li><p>Télécharger la dernière version de GeoNature :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PnX</span><span class="o">-</span><span class="n">SI</span><span class="o">/</span><span class="n">GeoNature</span><span class="o">/</span><span class="n">archive</span><span class="o">/</span><span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">unzip</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
<span class="n">rm</span> <span class="n">X</span><span class="o">.</span><span class="n">Y</span><span class="o">.</span><span class="n">Z</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
</li>
<li><p>Renommer l’ancien repertoire de l’application, ainsi que le nouveau :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mv /home/`whoami`/geonature/ /home/`whoami`/geonature_old/
mv GeoNature-X.Y.Z /home/`whoami`/geonature/
cd geonature
</pre></div>
</div>
</li>
<li><p>Suivez les éventuelles notes de version spécifiques décrites au niveau de chaque version : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/releases">https://github.com/PnX-SI/GeoNature/releases</a>.</p></li>
</ul>
<p>⚠️ Si la release inclut des scripts de migration SQL : <em>lancer ces scripts avec l’utilisateur de BDD courant</em> (généralement <code class="docutils literal notranslate"><span class="pre">geonatadmin</span></code>) et non le super-utilisateur <code class="docutils literal notranslate"><span class="pre">postgres</span></code>.</p>
<p>Sauf mentions contraires dans les notes de version, vous pouvez sauter des versions mais en suivant bien les différentes notes de versions intermédiaires et notamment les scripts de mise à jour de la base de données à exécuter successivement.</p>
<ul>
<li><p>Si vous devez aussi mettre à jour TaxHub et/ou UsersHub, suivez leurs notes de versions mais aussi leur documentation (<a class="reference external" href="https://usershub.readthedocs.io">https://usershub.readthedocs.io</a> et <a class="reference external" href="https://taxhub.readthedocs.io">https://taxhub.readthedocs.io</a>).</p></li>
<li><p>Lancez le script de <code class="docutils literal notranslate"><span class="pre">migration.sh</span></code> à la racine du dossier <code class="docutils literal notranslate"><span class="pre">geonature</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">install</span><span class="o">/</span><span class="n">migration</span><span class="o">/</span><span class="n">migration</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="passer-en-mode-developpement">
<h3>Passer en mode développement<a class="headerlink" href="#passer-en-mode-developpement" title="Permalink to this headline"></a></h3>
<p>Si vous avez téléchargé GeoNature zippé (via la procédure d’installation globale <code class="docutils literal notranslate"><span class="pre">install_all.sh</span></code> ou en suivant la documentation d’installation standalone), il est nécessaire de rattacher votre répertoire au dépôt GitHub afin de pouvoir télécharger les dernières avancées du coeur en <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">pull</span></code>. Pour cela, suivez les commandes suivantes en vous placant à la racine du répertoire de GeoNature.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span> <span class="n">Se</span> <span class="n">créer</span> <span class="n">un</span> <span class="n">répertoire</span> <span class="o">.</span><span class="n">git</span> <span class="o">---</span>
<span class="n">mkdir</span> <span class="o">.</span><span class="n">git</span>
<span class="o">---</span>  <span class="n">récupérer</span> <span class="n">l</span><span class="s1">&#39;historique du dépôt ---</span>
<span class="n">git</span> <span class="n">clone</span> <span class="o">--</span><span class="n">depth</span><span class="o">=</span><span class="mi">2</span> <span class="o">--</span><span class="n">bare</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">PnX</span><span class="o">-</span><span class="n">SI</span><span class="o">/</span><span class="n">GeoNature</span><span class="o">.</span><span class="n">git</span> <span class="o">.</span><span class="n">git</span>
<span class="o">---</span> <span class="n">initialiser</span> <span class="n">un</span> <span class="n">dépôt</span> <span class="n">git</span> <span class="n">à</span> <span class="n">partir</span> <span class="n">de</span> <span class="n">l</span><span class="s1">&#39;historique téléchargé ---</span>
<span class="n">git</span> <span class="n">init</span>
<span class="o">---</span> <span class="n">vérifier</span> <span class="n">que</span> <span class="n">le</span> <span class="n">dépôt</span> <span class="n">distant</span> <span class="n">et</span> <span class="n">le</span> <span class="n">contenu</span> <span class="n">local</span> <span class="n">sont</span> <span class="n">synchronisés</span> <span class="o">---</span>
<span class="n">git</span> <span class="n">pull</span>
<span class="o">---</span> <span class="n">Reset</span> <span class="n">sur</span> <span class="n">HEAD</span> <span class="n">pour</span> <span class="n">mettre</span> <span class="n">à</span> <span class="n">jour</span> <span class="n">les</span> <span class="n">status</span> <span class="o">---</span>
<span class="n">git</span> <span class="n">reset</span> <span class="n">HEAD</span>
<span class="o">-&gt;</span> <span class="n">vous</span> <span class="n">êtes</span> <span class="n">à</span> <span class="n">jour</span> <span class="n">sur</span> <span class="n">la</span> <span class="n">branche</span> <span class="n">master</span>
<span class="o">---</span> <span class="n">Cloner</span> <span class="n">les</span> <span class="n">sous</span><span class="o">-</span><span class="n">modules</span> <span class="n">pour</span> <span class="n">récupérer</span> <span class="n">les</span> <span class="n">dépendances</span>
<span class="n">git</span> <span class="n">submodule</span> <span class="n">init</span>
<span class="n">git</span> <span class="n">submodule</span> <span class="n">update</span>
<span class="o">---</span> <span class="n">Installer</span> <span class="n">les</span> <span class="n">dépendances</span> <span class="n">de</span> <span class="n">développement</span>
<span class="n">cd</span> <span class="n">backend</span> <span class="o">&amp;&amp;</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">r</span> <span class="n">requirements</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>&#64;TODO : A relire et à basculer dans DOC DEVELOPEMENT ?</p>
<p>Editez le fichier de configuration de GeoNature (<code class="docutils literal notranslate"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/config/geonature_config.toml</span></code>) de la manière suivante :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">URL_APPLICATION</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:4200&#39;</span>
<span class="n">API_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:8000&#39;</span>
<span class="n">API_TAXHUB</span> <span class="o">=</span>  <span class="s1">&#39;http://127.0.0.1:5000/api&#39;</span>
<span class="n">ID_APPLICATION_GEONATURE</span> <span class="o">=</span> <span class="mi">3</span>
</pre></div>
</div>
<p>Puis le fichier <code class="docutils literal notranslate"><span class="pre">/home/&lt;mon_user&gt;/geonature/frontend/src/conf/app.config.ts</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">URL_APPLICATION</span><span class="p">:</span> <span class="s1">&#39;http://127.0.0.1:4200&#39;</span><span class="p">,</span>
<span class="n">API_ENDPOINT</span><span class="p">:</span> <span class="s1">&#39;http://127.0.0.1:8000&#39;</span><span class="p">,</span>
<span class="n">API_TAXHUB</span><span class="p">:</span>  <span class="s1">&#39;http://127.0.0.1:5000/api&#39;</span><span class="p">,</span>
<span class="n">ID_APPLICATION_GEONATURE</span><span class="p">:</span> <span class="mi">3</span>
</pre></div>
</div>
<ul>
<li><p>Lancer le serveur de développement du frontend grâce à Angular-CLI :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">frontend</span>
<span class="n">npm</span> <span class="n">run</span> <span class="n">start</span>
</pre></div>
</div>
</li>
<li><p>Lancer l’API en mode développement</p></li>
</ul>
<p>Ouvrir un nouveau terminal :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">backend</span>
</pre></div>
</div>
<p>Stopper d’abord gunicorn qui est lancé en mode production via le supervisor :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">supervisorctl</span> <span class="n">stop</span> <span class="n">geonature2</span>
</pre></div>
</div>
<p>Puis lancer le backend en mode développement :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">geonature</span> <span class="n">dev_back</span>
</pre></div>
</div>
<p><strong>Le serveur de développement du backend est disponible à l’adresse 127.0.0.1:8000</strong></p>
<p><strong>Le serveur de développement du frontend est disponible à l’adresse 127.0.0.1:4200</strong>.</p>
<p>Vous pouvez vous connecter à l’application avec l’identifiant <code class="docutils literal notranslate"><span class="pre">admin</span></code> et le mot de passe <code class="docutils literal notranslate"><span class="pre">admin</span></code>.</p>
</div>
</div>
<div class="section" id="specificites-depobio">
<h2>Spécificités DEPOBIO<a class="headerlink" href="#specificites-depobio" title="Permalink to this headline"></a></h2>
<p>Cette documentation mentionne les spécificités et la configuration de l’installation de l’instance nationale du Ministère de la Transition Ecologique et Solidaire (MTES), dans le cadre du projet de Depôt Légal des données de biodiversité (<a class="reference external" href="https://depot-legal-biodiversite.naturefrance.fr/">https://depot-legal-biodiversite.naturefrance.fr/</a>).</p>
<p>Pour l’installation de GeoNature, voir la procédure d’installation de GeoNature et ses dépendances (<a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/docs/installation-all.rst">https://github.com/PnX-SI/GeoNature/blob/master/docs/installation-all.rst</a>).</p>
<div class="section" id="id5">
<h3>Configuration Apache<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h3>
<p>Editez la configuration Apache de GeoNature et de TaxHub pour l’adapter au
contexte de production.</p>
<p>Fichier <code class="docutils literal notranslate"><span class="pre">/etc/apache/site-enabled/geonature.conf</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Configuration GeoNature</span>

<span class="n">Alias</span> <span class="o">/</span><span class="n">saisie</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ecrins</span><span class="o">/</span><span class="n">geonature</span><span class="o">/</span><span class="n">frontend</span><span class="o">/</span><span class="n">dist</span>
<span class="o">&lt;</span><span class="n">Directory</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ecrins</span><span class="o">/</span><span class="n">geonature</span><span class="o">/</span><span class="n">frontend</span><span class="o">/</span><span class="n">dist</span><span class="o">&gt;</span>
    <span class="n">Require</span> <span class="nb">all</span> <span class="n">granted</span>
<span class="o">&lt;/</span><span class="n">Directory</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">Location</span> <span class="o">/</span><span class="n">saisie</span><span class="o">/</span><span class="n">api</span><span class="o">&gt;</span>
    <span class="n">ProxyPass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span>
    <span class="n">ProxyPassReverse</span>  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8000</span>
<span class="o">&lt;/</span><span class="n">Location</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Fichier <code class="docutils literal notranslate"><span class="pre">/etc/apache/site-enabled/taxhub.conf</span></code> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configuration TaxHub</span>
<span class="n">RewriteEngine</span>  <span class="n">on</span>
<span class="n">RewriteRule</span>    <span class="s2">&quot;taxhub$&quot;</span>  <span class="s2">&quot;taxhub/&quot;</span>  <span class="p">[</span><span class="n">R</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">Location</span> <span class="o">/</span><span class="n">saisie</span><span class="o">/</span><span class="n">taxhub</span><span class="o">&gt;</span>
    <span class="n">ProxyPass</span>  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">5000</span> <span class="n">retry</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ProxyPassReverse</span>  <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">5000</span>
<span class="o">&lt;/</span><span class="n">Location</span><span class="o">&gt;</span>
<span class="c1">#FIN Configuration TaxHub</span>
</pre></div>
</div>
<p>Le fichier <code class="docutils literal notranslate"><span class="pre">/etc/apache/site-enabled/000-default.conf</span></code> doit également être
édité pour faire fonctionner le load balancing (Voir la configuration de la
pre-prod pour l’adapter au serveur de production).</p>
</div>
<div class="section" id="configuration-de-l-application">
<h3>Configuration de l’application<a class="headerlink" href="#configuration-de-l-application" title="Permalink to this headline"></a></h3>
<p>Une fois l’installation terminée, il est nécessaire d’adapter les fichiers de
configuration de l’application pour les besoins spécifiques de
l’instance nationale.</p>
<p>Lancer le script pour effectuer automatiquement la configuration
de l’application :</p>
<p><code class="docutils literal notranslate"><span class="pre">/home/&lt;my_user&gt;/geonature/install/install_all/configuration_mtes.sh</span></code></p>
<p>Il est cependant possible de modifier ces configurations.
Le fichier <code class="docutils literal notranslate"><span class="pre">/home/&lt;my_user&gt;/geonature/config/default_config.toml.example</span></code>
liste l’ensemble des variables de configuration disponibles ainsi que leurs
valeurs par défaut.</p>
<p>Editer le fichier de configuration de GeoNature pour surcoucher ces variables :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo nano /home/&lt;MON_USER&gt;/geonature/config/geonature_config.toml`
</pre></div>
</div>
<p>Ci-dessous, les paramètres de configuration pour l’instance de production.</p>
<div class="section" id="configuration-globale-de-l-application">
<h4>Configuration globale de l’application<a class="headerlink" href="#configuration-globale-de-l-application" title="Permalink to this headline"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># code EPSG de la projection de la base</span>
<span class="n">LOCAL_SRID</span> <span class="o">=</span> <span class="s1">&#39;2154&#39;</span>

<span class="n">DEFAULT_LANGUAGE</span><span class="o">=</span><span class="s1">&#39;fr&#39;</span>

<span class="c1"># url de l&#39;application métadonnée</span>
<span class="n">MTD_API_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;http://inpn.mnhn.fr/mtd&#39;</span>

<span class="c1"># Nom de l&#39;application sur la page d&#39;acceuil</span>
<span class="n">appName</span> <span class="o">=</span> <span class="s1">&#39;Depôt légal de biodiviersité - saisie&#39;</span>

<span class="n">ID_APPLICATION_GEONATURE</span> <span class="o">=</span> <span class="mi">14</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-des-urls-pour-le-cas">
<h4>Configuration des URLS pour le CAS<a class="headerlink" href="#configuration-des-urls-pour-le-cas" title="Permalink to this headline"></a></h4>
<p>Les URLS doivent correspondre aux informations renseignées dans la
configuration Apache et au Load Balancer. Elle ne doivent pas contenir
de <code class="docutils literal notranslate"><span class="pre">/</span></code> final.</p>
<p>Pour la pré-prod, ajouter le préfixe “pp-” avant <code class="docutils literal notranslate"><span class="pre">saisie</span></code> et <code class="docutils literal notranslate"><span class="pre">taxhub</span></code>
(naturefrance.fr/pp-saisie, naturefrance.fr/pp-taxhub/api) et adapter la
configuration Apache en conséquence.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># URL d&#39;accès à l&#39;application</span>
<span class="n">URL_APPLICATION</span> <span class="o">=</span> <span class="s1">&#39;https://depot-legal-biodiversite.naturefrance.fr/saisie&#39;</span>
<span class="c1"># URL de l&#39;API de GeoNature</span>
<span class="n">API_ENDPOINT</span> <span class="o">=</span> <span class="s1">&#39;https://depot-legal-biodiversite.naturefrance.fr/saisie/api&#39;</span>
<span class="c1"># URL de l&#39;API de Taxhub</span>
<span class="n">API_TAXHUB</span> <span class="o">=</span> <span class="s1">&#39;https://depot-legal-biodiversite.naturefrance.fr/taxhub/api&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="cle-secrete">
<h4>Clé secrète<a class="headerlink" href="#cle-secrete" title="Permalink to this headline"></a></h4>
<p>Mettre un clé secrète personnalisée</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="s1">&#39;&lt;MA_CLE_CRYPTEE&gt;&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-bdd-liee-a-la-connexion-au-cas">
<h4>Configuration BDD liée à la connexion au CAS<a class="headerlink" href="#configuration-bdd-liee-a-la-connexion-au-cas" title="Permalink to this headline"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">BDD</span><span class="p">]</span>
<span class="c1"># id du groupe dans lequel tous les utilisateurs connectés sont ajoutés</span>
<span class="c1"># (seul le socle 1 - droit minimum - est utilisé pour l&#39;instance de production)</span>
<span class="n">ID_USER_SOCLE_1</span> <span class="o">=</span> <span class="mi">20003</span>
<span class="n">ID_USER_SOCLE_2</span> <span class="o">=</span> <span class="mi">20001</span>
</pre></div>
</div>
</div>
<div class="section" id="connexion-au-cas-inpn-gestion-centralisee-des-utilisateurs">
<h4>Connexion au CAS INPN - gestion centralisée des utilisateurs<a class="headerlink" href="#connexion-au-cas-inpn-gestion-centralisee-des-utilisateurs" title="Permalink to this headline"></a></h4>
<p>Bien changer les variables ID et PASSWORD avec les bonnes valeurs.</p>
<p>NB : pour la pré-prod, utiliser <code class="docutils literal notranslate"><span class="pre">https://preprod-inpn.mnhn.fr</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">CAS_PUBLIC</span><span class="p">]</span>
<span class="n">CAS_AUTHENTIFICATION</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">CAS_URL_LOGIN</span> <span class="o">=</span> <span class="s1">&#39;https://inpn.mnhn.fr/auth/login&#39;</span>
<span class="n">CAS_URL_LOGOUT</span> <span class="o">=</span> <span class="s1">&#39;https://inpn.mnhn.fr/auth/logout&#39;</span>

<span class="p">[</span><span class="n">CAS</span><span class="p">]</span>
<span class="n">CAS_URL_VALIDATION</span> <span class="o">=</span> <span class="s1">&#39;https://inpn.mnhn.fr/auth/serviceValidate&#39;</span>
<span class="c1"># est ce que les utilisateurs connecté peuvent voir les donées de leur organisme</span>
<span class="n">USERS_CAN_SEE_ORGANISM_DATA</span> <span class="o">=</span> <span class="n">false</span>

<span class="p">[</span><span class="n">CAS</span><span class="o">.</span><span class="n">CAS_USER_WS</span><span class="p">]</span>
<span class="n">URL</span> <span class="o">=</span> <span class="s1">&#39;https://inpn.mnhn.fr/authentication/information&#39;</span>
<span class="n">ID</span> <span class="o">=</span> <span class="s1">&#39;&lt;THE_INPN_LOGIN&gt;&#39;</span>
<span class="n">PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;&lt;THE_INPN_PASSWORD&gt;&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-du-frontend">
<h4>Configuration du frontend<a class="headerlink" href="#configuration-du-frontend" title="Permalink to this headline"></a></h4>
<p>Pour l’instance de pré-prod, rajouter “instance de démo” à la variable
<code class="docutils literal notranslate"><span class="pre">appName</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">FRONTEND</span><span class="p">]</span>
    <span class="c1"># Compilation du fronend en mode production</span>
    <span class="n">PROD_MOD</span> <span class="o">=</span> <span class="n">true</span>
    <span class="c1"># Affichage du footer sur la page d&#39;acceuil</span>
    <span class="n">DISPLAY_FOOTER</span> <span class="o">=</span> <span class="n">true</span>
    <span class="c1"># affiche la carte des dernières observations basées sur la synthese</span>
    <span class="n">DISPLAY_MAP_LAST_OBS</span> <span class="o">=</span> <span class="n">false</span>
    <span class="c1"># afficheafficher un bloc de stat basé sur la synthese</span>
    <span class="n">DISPLAY_STAT_BLOC</span> <span class="o">=</span> <span class="n">false</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-de-la-cartographie">
<h4>Configuration de la cartographie<a class="headerlink" href="#configuration-de-la-cartographie" title="Permalink to this headline"></a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">MAPCONFIG</span><span class="p">]</span>
<span class="n">BASEMAP</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="s2">&quot;IGN-topo&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://wxs.ign.fr/i53afxeajwaokg3gxzzhn8un/geoportail/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=GEOGRAP$</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">=</span> <span class="s2">&quot;IGN-Scan Express&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://wxs.ign.fr/i53afxeajwaokg3gxzzhn8un/geoportail/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=$</span>
    <span class="p">{</span><span class="s2">&quot;name&quot;</span> <span class="o">=</span> <span class="s2">&quot;IGN-Ortho&quot;</span><span class="p">,</span> <span class="s2">&quot;layer&quot;</span> <span class="o">=</span> <span class="s2">&quot;https://wxs.ign.fr/i53afxeajwaokg3gxzzhn8un/geoportail/wmts?SERVICE=WMTS&amp;REQUEST=GetTile&amp;VERSION=1.0.0&amp;LAYER=ORTHOI$</span>
<span class="p">]</span>
<span class="c1"># Attention: les coordonnées sont au format [Y, X] - cf leaflet configuration (https://leafletjs.com/reference-1.4.0.html#latlng-l-latlng)</span>
<span class="n">CENTER</span> <span class="o">=</span> <span class="p">[</span><span class="mf">46.52863469527167</span><span class="p">,</span> <span class="mf">2.43896484375</span><span class="p">]</span>
<span class="c1"># Zoom par défaut</span>
<span class="n">ZOOM_LEVEL</span> <span class="o">=</span> <span class="mi">6</span>
<span class="c1"># Zoom à partir duquel on peut pointer un releve</span>
<span class="n">ZOOM_LEVEL_RELEVE</span> <span class="o">=</span> <span class="mi">15</span>
</pre></div>
</div>
<p>Après chaque modification du fichier de configuration, lancez les commandes
suivantes pour mettre à jour l’application (l’opération peut être longue car
il s’agit de la recompilation du frontend).</p>
<p>Depuis le répertoire <code class="docutils literal notranslate"><span class="pre">backend</span></code> de GeoNature</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">geonature</span> <span class="n">update_configuration</span>
<span class="n">deactivate</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration-du-module-occurrence-de-taxon-occtax">
<h4>Configuration du module Occurrence de taxon: OCCTAX<a class="headerlink" href="#configuration-du-module-occurrence-de-taxon-occtax" title="Permalink to this headline"></a></h4>
<p>Le fichier de configuration du module Occtax se trouve dans le fichier
<code class="docutils literal notranslate"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/external_modules/occtax/config/conf_gn_module.toml</span></code>.</p>
<p>Le script de configuration spécifique de l’instance nationale remplit ce
fichier avec les bonnes configuration.</p>
<p>Voici la configuration fournie pour l’instance de production:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api_url</span> <span class="o">=</span> <span class="s1">&#39;/occtax&#39;</span>

<span class="c1"># message sur la modale des export pour préciser les consignes pour GINCO</span>
<span class="n">export_message</span> <span class="o">=</span> <span class="s2">&quot;&lt;p&gt; &lt;b&gt; Attention: &lt;/b&gt; &lt;/br&gt; Vous vous apprêtez à télécharger les données de la &lt;b&gt;recherche courante.&lt;/b&gt; &lt;/br&gt; Pour n&#39;exporter qu&#39;un &lt;b&gt;$</span>

<span class="c1"># format disponible pour l&#39;export</span>
<span class="n">export_available_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;geojson&#39;</span><span class="p">]</span>

<span class="c1"># passage du champ observateur du formulaire de saisi en mode &#39;saisie libre&#39;</span>
<span class="n">observers_txt</span> <span class="o">=</span> <span class="n">true</span>

<span class="c1"># identifiant de la liste des taxon proposé dans le formulaire (voir table taxonomie.bib_listes et taxonomie.cor_nom_liste)</span>
<span class="n">id_taxon_list</span> <span class="o">=</span> <span class="mi">500</span>

<span class="c1"># niveau de zoom à partir duquel on peut saisir un relevé sur la carte</span>
<span class="n">releve_map_zoom_level</span> <span class="o">=</span> <span class="mi">15</span>

<span class="c1"># colonnes de la vue pr_occtax.export_occtax_sinp à exporter pour GINCO dépot légal</span>
<span class="n">export_columns</span> <span class="o">=</span>  <span class="p">[</span>
    <span class="s2">&quot;permId&quot;</span><span class="p">,</span>
    <span class="s2">&quot;statObs&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nomCite&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dateDebut&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dateFin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;heureDebut&quot;</span><span class="p">,</span>
    <span class="s2">&quot;heureFin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;altMax&quot;</span><span class="p">,</span>
    <span class="s2">&quot;altMin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cdNom&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cdRef&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dateDet&quot;</span><span class="p">,</span>
    <span class="s2">&quot;comment&quot;</span><span class="p">,</span>
    <span class="s2">&quot;dSPublique&quot;</span><span class="p">,</span>
    <span class="s2">&quot;statSource&quot;</span><span class="p">,</span>
    <span class="s2">&quot;idOrigine&quot;</span><span class="p">,</span>
    <span class="s2">&quot;refBiblio&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obsMeth&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocEtatBio&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocNat&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocSex&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocStade&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocBiogeo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocStatBio&quot;</span><span class="p">,</span>
    <span class="s2">&quot;preuveOui&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ocMethDet&quot;</span><span class="p">,</span>
    <span class="s2">&quot;preuvNum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;preuvNoNum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obsCtx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;permIdGrp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;methGrp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;typGrp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;denbrMax&quot;</span><span class="p">,</span>
    <span class="s2">&quot;denbrMin&quot;</span><span class="p">,</span>
    <span class="s2">&quot;objDenbr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;typDenbr&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obsId&quot;</span><span class="p">,</span>
    <span class="s2">&quot;obsNomOrg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detId&quot;</span><span class="p">,</span>
    <span class="s2">&quot;detNomOrg&quot;</span><span class="p">,</span>
    <span class="s2">&quot;orgGestDat&quot;</span><span class="p">,</span>
    <span class="s2">&quot;WKT&quot;</span><span class="p">,</span>
    <span class="s2">&quot;natObjGeo&quot;</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>Le fichier
<code class="docutils literal notranslate"><span class="pre">&lt;GEONATURE_DIRECTORY&gt;/external_modules/occtax/config/conf_gn_module.toml.example</span></code>
liste l’ensemble des variables de configuration du module Occtax ainsi que
leurs valeurs par défault.</p>
<p>Après chaque modification du fichier de configuration, lancez les commandes
suivantes pour mettre à jour l’application (l’opération peut être longue car
il s’agit de la recompilation du frontend).</p>
<p>Depuis le répertoire <code class="docutils literal notranslate"><span class="pre">backend</span></code> de GeoNature</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">venv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">activate</span>
<span class="n">geonature</span> <span class="n">update_module_configuration</span> <span class="n">occtax</span>
<span class="n">deactivate</span>
</pre></div>
</div>
<p>Pour plus d’information sur la configuration du module Occtax, voir la documentation concernant le module (<a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/docs/admin-manual.rst#module-occtax">https://github.com/PnX-SI/GeoNature/blob/master/docs/admin-manual.rst#module-occtax</a>).</p>
</div>
</div>
<div class="section" id="referentiel-geographique">
<h3>Référentiel géographique<a class="headerlink" href="#referentiel-geographique" title="Permalink to this headline"></a></h3>
<p>Sur l’instance nationale on charge dans le référentiel géographique
l’ensemble des communes du territoire français, ainsi qu’un MNT (modèle
numérique de terrain) national de résolution 250m (pour le calcul automatique
des altitudes pour chaque observation).</p>
<img alt="http://geonature.fr/docs/img/admin-manual/design-geonature-mtes.png" src="http://geonature.fr/docs/img/admin-manual/design-geonature-mtes.png" />
</div>
<div class="section" id="authentification-cas-inpn">
<h3>Authentification CAS INPN<a class="headerlink" href="#authentification-cas-inpn" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>Code source : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/backend/geonature/core/auth/routes.py">https://github.com/PnX-SI/GeoNature/blob/master/backend/geonature/core/auth/routes.py</a></p></li>
<li><p>Config : <a class="reference external" href="https://github.com/PnX-SI/GeoNature/blob/master/config/default_config.toml.example#L124-L135">https://github.com/PnX-SI/GeoNature/blob/master/config/default_config.toml.example#L124-L135</a></p></li>
</ul>
</div>
<div class="section" id="connexion-et-droits-dans-geonature">
<h3>Connexion et droits dans GeoNature<a class="headerlink" href="#connexion-et-droits-dans-geonature" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p>A chaque connexion via le CAS INPN on récupère l’ID_Utilisateur.
On ajoute cet utilisateur dans la base de données de GeoNature
(<code class="docutils literal notranslate"><span class="pre">utilisateurs.t_roles</span></code> et <code class="docutils literal notranslate"><span class="pre">utilisateurs.bib_organisme</span></code>) et on
lui affecte des droits CRUVED par défaut.</p></li>
<li><p>On assigne à l’utilisateur le « socle 1 » (C1-R1-V0-E1-D1). Il pourra voir
seulement les données qu’il a saisi lui-même et les JDD qu’il a
créé dans MTD.</p></li>
</ul>
<p>NB sur la gestion des droits dans GeoNature :</p>
<ul class="simple">
<li><p>6 actions sont possibles dans GeoNature :
Create / Read / Update / Validate / Export / Delete (aka CRUVED).</p></li>
<li><p>3 portées de ces actions sont possibles :
Mes données / Les données de mon organisme / Toutes les données.</p></li>
</ul>
</div>
<div class="section" id="recuperation-des-jdd">
<h3>Récupération des JDD<a class="headerlink" href="#recuperation-des-jdd" title="Permalink to this headline"></a></h3>
<p>Grâce à l’API de MTD, il est désormais possible d’ajouter les jeux de données
(et des cadres d’acquisition) créés dans MTD dans la BDD GeoNature.</p>
<ul class="simple">
<li><p>On récupère la liste des JDD créés par l’utilisateur grâce à l’API MTD au
chargement de la liste déroulante des JDD :
<a class="reference external" href="https://xxxxx/cadre/jdd/export/xml/GetRecordsByUserId">https://xxxxx/cadre/jdd/export/xml/GetRecordsByUserId</a>?id=&lt;ID_USER&gt;</p></li>
<li><p>On récupère l’UUID du cadre CA associé au JDD dans le XML renvoyé et on fait
appel au l’API MTD pour récupérer le fichier XML du CA :
<a class="reference external" href="https://xxxxx/cadre/export/xml/GetRecordById">https://xxxxx/cadre/export/xml/GetRecordById</a>?id=&lt;UUID&gt;</p></li>
<li><p>On ajoute le CA dans la table <code class="docutils literal notranslate"><span class="pre">gn_meta.t_acquisition_framwork</span></code> et les JDD
dans la table <code class="docutils literal notranslate"><span class="pre">gn_meta.t_datasets</span></code>. Si le CA ou les JDD sont modifiés dans
MTD, ils seront également modifiés dans le BDD GeoNature.</p></li>
<li><p>Dans la table <code class="docutils literal notranslate"><span class="pre">gn_meta.cor_dataset_actor</span></code> on fait le lien entre les
acteurs et le JDD. On ajoute l’utilisateur qui a créé le JDD comme
“Point de contact principal” du JDD. Si on dispose de l’ID_Organisme de
l’utilisateur, on ajoute également l’organisme comme
“Point de contact principal” du JDD.</p></li>
<li><p>Pour remplir cette table on ne prend pas les infos renvoyés par le
XML JDD sous l’intitulé « Acteur » puisque l’ID_Organisme ou l’ID_Acteur
n’est pas renseigné. (Dans la table <code class="docutils literal notranslate"><span class="pre">gn_meta.cor_dataset_actor</span></code>, il faut
obligatoirement un ID).</p></li>
<li><p>La question de la suppresion de JDD et des CA n’est pas résolue. Si un JDD
est supprimé dans MTD, qu’est-ce qu’on fait des données associées a celui-ci
dans GeoNature ?</p></li>
</ul>
</div>
<div class="section" id="module-synthese">
<h3>Module Synthese<a class="headerlink" href="#module-synthese" title="Permalink to this headline"></a></h3>
<p>Sur l’instance DEPOPBIO le module synthese a été désactivé en mettant un
CRUVED à 0 au groupe socle 1 et socle 2 pour le module.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">INSERT</span> <span class="n">INTO</span> <span class="n">gn_permissions</span><span class="o">.</span><span class="n">cor_role_action_filter_module_object</span>
  <span class="p">(</span>
  <span class="n">id_role</span><span class="p">,</span>
  <span class="n">id_action</span><span class="p">,</span>
  <span class="n">id_filter</span><span class="p">,</span>
  <span class="n">id_module</span><span class="p">,</span>
  <span class="n">id_object</span>
  <span class="p">)</span>
  <span class="n">VALUES</span>
  <span class="o">--</span> <span class="n">synthese</span> <span class="n">pour</span> <span class="n">socle</span> <span class="mi">1</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
 <span class="o">--</span> <span class="n">synthese</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="o">--</span> <span class="n">admin</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="o">--</span> <span class="n">admin</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="o">--</span> <span class="n">meta</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20003</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<span class="o">--</span> <span class="n">meta</span> <span class="n">socle</span> <span class="mi">2</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
  <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">;</span>
</pre></div>
</div>
<p>Les triggers d’insertion du module Occtax vers le module Synthese ont
également été désactivés.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">t_releves_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_update_synthese_t_releve_occtax</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">t_releves_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_delete_synthese_t_releve_occtax</span><span class="p">;</span>

<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">t_occurrences_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_update_synthese_t_occurrence_occtax</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">t_occurrences_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_delete_synthese_t_occurrence_occtax</span><span class="p">;</span>

<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">cor_counting_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_insert_synthese_cor_counting_occtax</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">cor_counting_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_update_synthese_cor_counting_occtax</span><span class="p">;</span>
<span class="n">ALTER</span> <span class="n">TABLE</span> <span class="n">pr_occtax</span><span class="o">.</span><span class="n">cor_counting_occtax</span> <span class="n">DISABLE</span> <span class="n">TRIGGER</span> <span class="n">tri_delete_synthese_cor_counting_occtax</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Bienvenue dans la documentation de GeoNature" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="user-manual.html" class="btn btn-neutral float-right" title="MANUEL UTILISATEUR" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2019, PnE, PnC.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>